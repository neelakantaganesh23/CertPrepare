// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  password_hash        String
  first_name           String?
  last_name            String?
  avatar_url           String?
  role                 String    @default("STUDENT")
  email_verified       Boolean   @default(false)
  email_verified_at    DateTime?
  is_active            Boolean   @default(true)
  created_at           DateTime  @default(now())
  updated_at           DateTime  @updatedAt
  last_login           DateTime?

  // Relations
  attempts             UserAttempt[]
  progress             UserProgress[]
  bookmarks            BookmarkedQuestion[]
  notes                StudyNote[]
  flashcards           Flashcard[]
  flashcard_reviews    FlashcardReview[]
  quiz_attempts        QuizAttempt[]
  quiz_submissions     QuizSubmission[]
  mock_exam_attempts   MockExamAttempt[]

  @@index([email])
  @@index([role])
}

model Certification {
  id                String   @id @default(cuid())
  name              String   @unique
  description       String?
  passing_score     Int      @default(70)
  duration_minutes  Int      @default(180)
  total_questions   Int      @default(50)
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relations
  topics            Topic[]
  user_progress     UserProgress[]
  study_materials   StudyMaterial[]
  exam_questions    ExamQuestion[]
  quiz_attempts     QuizAttempt[]
  quiz_submissions  QuizSubmission[]
  exam_dumps        ExamDump[]
  mock_exams        MockExam[]

  @@index([is_active])
}

model Topic {
  id                String   @id @default(cuid())
  certification_id  String
  name              String
  description       String?
  order_index       Int      @default(0)
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  certification     Certification @relation(fields: [certification_id], references: [id], onDelete: Cascade)
  questions         Question[]
  user_progress     UserProgress[]
  study_notes       StudyNote[]
  flashcards        Flashcard[]

  @@unique([certification_id, name])
  @@index([certification_id])
}

model Question {
  id                String   @id @default(cuid())
  topic_id          String
  question_text     String
  type              String   @default("MULTIPLE_CHOICE")
  difficulty        String   @default("MEDIUM")
  explanation       String?
  image_url         String?
  code_snippet      String?
  tags              String   @default("[]")
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  topic             Topic    @relation(fields: [topic_id], references: [id], onDelete: Cascade)
  answers           Answer[]
  user_attempts     AttemptedQuestion[]
  bookmarks         BookmarkedQuestion[]

  @@index([topic_id])
  @@index([difficulty])
  @@index([type])
}

model Answer {
  id                String   @id @default(cuid())
  question_id       String
  answer_text       String
  is_correct        Boolean
  explanation       String?
  order_index       Int      @default(0)
  created_at        DateTime @default(now())

  question          Question @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@index([question_id])
}

model UserAttempt {
  id                String   @id @default(cuid())
  user_id           String
  certification_id  String
  exam_name         String?
  total_questions   Int
  correct_answers   Int
  score             Float
  is_passed         Boolean
  started_at        DateTime
  completed_at      DateTime
  duration_seconds  Int
  created_at        DateTime @default(now())

  user              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  attempted_questions AttemptedQuestion[]

  @@index([user_id])
  @@index([certification_id])
  @@index([completed_at])
}

model AttemptedQuestion {
  id                String   @id @default(cuid())
  user_attempt_id   String
  question_id       String
  selected_answer_id String?
  is_correct        Boolean
  time_spent_seconds Int      @default(0)
  created_at        DateTime @default(now())

  user_attempt      UserAttempt @relation(fields: [user_attempt_id], references: [id], onDelete: Cascade)
  question          Question    @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@unique([user_attempt_id, question_id])
  @@index([user_attempt_id])
  @@index([question_id])
}

model UserProgress {
  id                String   @id @default(cuid())
  user_id           String
  certification_id  String
  topic_id          String
  mastery_level     Int      @default(0) // 0-100
  questions_seen    Int      @default(0)
  questions_correct Int      @default(0)
  last_practiced    DateTime?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  user              User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  certification     Certification @relation(fields: [certification_id], references: [id], onDelete: Cascade)
  topic             Topic         @relation(fields: [topic_id], references: [id], onDelete: Cascade)

  @@unique([user_id, certification_id, topic_id])
  @@index([user_id])
  @@index([certification_id])
  @@index([topic_id])
}

model BookmarkedQuestion {
  id                String   @id @default(cuid())
  user_id           String
  question_id       String
  created_at        DateTime @default(now())

  user              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  question          Question @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@unique([user_id, question_id])
  @@index([user_id])
}

model StudyNote {
  id                String   @id @default(cuid())
  user_id           String
  topic_id          String
  title             String
  content           String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  user              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  topic             Topic    @relation(fields: [topic_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([topic_id])
}

model Flashcard {
  id                String   @id @default(cuid())
  user_id           String
  topic_id          String
  front_text        String
  back_text         String
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  user              User              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  topic             Topic             @relation(fields: [topic_id], references: [id], onDelete: Cascade)
  reviews           FlashcardReview[]

  @@index([user_id])
  @@index([topic_id])
}

model FlashcardReview {
  id                String   @id @default(cuid())
  flashcard_id      String
  user_id           String
  quality           Int      // 0-5 scale (0=incorrect, 5=perfect)
  reviewed_at       DateTime @default(now())

  flashcard         Flashcard @relation(fields: [flashcard_id], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([flashcard_id])
  @@index([user_id])
  @@index([reviewed_at])
}
model StudyMaterial {
  id                String   @id @default(cuid())
  certification_id  String
  title             String
  description       String?
  url               String
  type              String   @default("DOCUMENTATION") // DOCUMENTATION, BLOG, VIDEO, COURSE
  category          String?  // Topic category this material covers
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  certification     Certification @relation(fields: [certification_id], references: [id], onDelete: Cascade)

  @@index([certification_id])
  @@index([type])
}

model ExamQuestion {
  id                String   @id @default(cuid())
  certification_id  String
  question_text     String
  question_type     String   @default("MULTIPLE_CHOICE") // MULTIPLE_CHOICE, ESSAY, TRUE_FALSE
  difficulty        String   @default("MEDIUM")
  explanation       String?
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  certification     Certification  @relation(fields: [certification_id], references: [id], onDelete: Cascade)
  options           QuestionOption[]
  quiz_attempts     QuizAttempt[]

  @@index([certification_id])
  @@index([difficulty])
}

model QuestionOption {
  id                String   @id @default(cuid())
  question_id       String
  option_text       String
  is_correct        Boolean  @default(false)
  order_index       Int      @default(0)
  created_at        DateTime @default(now())

  question          ExamQuestion @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@index([question_id])
}

model QuizAttempt {
  id                String   @id @default(cuid())
  user_id           String
  certification_id  String
  question_id       String
  selected_option_id String?
  is_correct        Boolean?
  time_spent_seconds Int      @default(0)
  created_at        DateTime @default(now())

  user              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  certification     Certification @relation(fields: [certification_id], references: [id], onDelete: Cascade)
  question          ExamQuestion  @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([certification_id])
}

model QuizSubmission {
  id                String   @id @default(cuid())
  user_id           String
  certification_id  String
  total_questions   Int
  correct_answers   Int
  score             Float
  passed            Boolean
  submitted_at      DateTime @default(now())
  created_at        DateTime @default(now())

  user              User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  certification     Certification @relation(fields: [certification_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([certification_id])
}

model ExamDump {
  id                String   @id @default(cuid())
  certification_id  String
  title             String
  description       String?
  source_url        String?
  difficulty        String   @default("MEDIUM")
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  certification     Certification @relation(fields: [certification_id], references: [id], onDelete: Cascade)
  dump_questions    DumpQuestion[]

  @@index([certification_id])
}

model DumpQuestion {
  id                String   @id @default(cuid())
  dump_id           String
  question_text     String
  explanation       String?
  source            String?  // Source website or certified user
  created_at        DateTime @default(now())

  dump              ExamDump @relation(fields: [dump_id], references: [id], onDelete: Cascade)

  @@index([dump_id])
}

model MockExam {
  id                String   @id @default(cuid())
  certification_id  String
  title             String
  description       String?
  duration_minutes  Int      @default(120)
  total_questions   Int      @default(50)
  passing_score     Int      @default(70)
  is_active         Boolean  @default(true)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  certification     Certification      @relation(fields: [certification_id], references: [id], onDelete: Cascade)
  mock_attempts     MockExamAttempt[]

  @@index([certification_id])
}

model MockExamAttempt {
  id                String   @id @default(cuid())
  user_id           String
  mock_exam_id      String
  started_at        DateTime @default(now())
  completed_at      DateTime?
  total_questions   Int
  correct_answers   Int
  score             Float?
  passed            Boolean?
  time_taken_seconds Int?
  created_at        DateTime @default(now())

  user              User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  mock_exam         MockExam     @relation(fields: [mock_exam_id], references: [id], onDelete: Cascade)
  answers           MockExamAnswer[]

  @@index([user_id])
  @@index([mock_exam_id])
}

model MockExamAnswer {
  id                String   @id @default(cuid())
  attempt_id        String
  question_id       String
  selected_answer   String?
  is_correct        Boolean?
  time_spent_seconds Int      @default(0)

  attempt           MockExamAttempt @relation(fields: [attempt_id], references: [id], onDelete: Cascade)

  @@unique([attempt_id, question_id])
  @@index([attempt_id])
}